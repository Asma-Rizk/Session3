USE master;
GO

DROP DATABASE IF EXISTS COMPANY1;
GO

CREATE DATABASE COMPANY1;
GO

USE COMPANY1;
GO

CREATE SCHEMA HR;
GO

CREATE TABLE DEPARTMENT (
    DeptID INT PRIMARY KEY,
    DeptName VARCHAR(50) NOT NULL UNIQUE,
    Location VARCHAR(50)
);

CREATE TABLE PROJECT (
    ProjectID INT PRIMARY KEY,
    ProjectName VARCHAR(100) NOT NULL,
    Budget DECIMAL(10, 2)
);

CREATE TABLE EMPLOYEE (
    EmpID INT PRIMARY KEY,
    EmpName VARCHAR(100) NOT NULL,
    HireDate DATE,
    Salary DECIMAL(10, 2),
    DeptID INT, 
    FOREIGN KEY (DeptID) REFERENCES DEPARTMENT(DeptID)
);

CREATE TABLE EMPLOYEE_PROJECT (
    EmpID INT,
    ProjectID INT,
    WorkingHours INT,
    PRIMARY KEY (EmpID, ProjectID),
    FOREIGN KEY (EmpID) REFERENCES EMPLOYEE(EmpID),
    FOREIGN KEY (ProjectID) REFERENCES PROJECT(ProjectID)
);

INSERT INTO DEPARTMENT VALUES (1, 'HR', 'Cairo');
INSERT INTO DEPARTMENT VALUES (2, 'IT', 'Alexandria');
INSERT INTO DEPARTMENT VALUES (3, 'Finance', 'Giza');

INSERT INTO EMPLOYEE VALUES (101, 'Ali Ahmed', '2021-01-10', 8000, 1);
INSERT INTO EMPLOYEE VALUES (102, 'Sara Ali', '2022-03-15', 9000, 2);
INSERT INTO EMPLOYEE VALUES (103, 'Hana Youssef', '2023-06-20', 8500, 2);
INSERT INTO EMPLOYEE VALUES (104, 'Mohamed Tarek', '2020-11-05', 7500, 3);
INSERT INTO EMPLOYEE VALUES (105, 'Laila Nour', '2019-09-30', 9500, 1);

INSERT INTO PROJECT VALUES (201, 'Website Redesign', 50000);
INSERT INTO PROJECT VALUES (202, 'ERP Implementation', 100000);
INSERT INTO PROJECT VALUES (203, 'Recruitment Campaign', 20000);

INSERT INTO EMPLOYEE_PROJECT VALUES (101, 203, 10);
INSERT INTO EMPLOYEE_PROJECT VALUES (102, 201, 20);
INSERT INTO EMPLOYEE_PROJECT VALUES (103, 201, 15);
INSERT INTO EMPLOYEE_PROJECT VALUES (104, 202, 25);
INSERT INTO EMPLOYEE_PROJECT VALUES (105, 203, 5);

UPDATE EMPLOYEE
SET DeptID = 2
WHERE EmpID = 101;

DELETE FROM EMPLOYEE_PROJECT
WHERE EmpID = 102 AND ProjectID = 201;

SELECT *
FROM EMPLOYEE
WHERE DeptID = (
    SELECT DeptID FROM DEPARTMENT WHERE DeptName = 'IT'
);

SELECT E.EmpName, P.ProjectName, EP.WorkingHours
FROM EMPLOYEE_PROJECT EP
JOIN EMPLOYEE E ON EP.EmpID = E.EmpID
JOIN PROJECT P ON EP.ProjectID = P.ProjectID;

CREATE TABLE DEPENDENT (
    DepID INT PRIMARY KEY IDENTITY(1,1),
    EmpID INT NOT NULL,
    DepName VARCHAR(100) NOT NULL,
    Gender CHAR(1) CHECK (Gender IN ('M', 'F')),
    Relationship VARCHAR(50),
    FOREIGN KEY (EmpID) REFERENCES EMPLOYEE(EmpID)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

ALTER TABLE DEPARTMENT
ADD ManagerID INT UNIQUE;

ALTER TABLE DEPARTMENT
ADD ManagerID INT;

UPDATE DEPARTMENT SET ManagerID = 101 WHERE DeptID = 1;
UPDATE DEPARTMENT SET ManagerID = 102 WHERE DeptID = 2;
UPDATE DEPARTMENT SET ManagerID = 104 WHERE DeptID = 3;

ALTER TABLE DEPARTMENT
ADD CONSTRAINT UQ_Manager UNIQUE (ManagerID);

ALTER TABLE DEPARTMENT
ADD CONSTRAINT FK_Manager_Department FOREIGN KEY (ManagerID)
REFERENCES EMPLOYEE(EmpID)
    ON DELETE SET NULL
    ON UPDATE CASCADE;
  
ALTER TABLE EMPLOYEE
ADD NationalID VARCHAR(14);

ALTER TABLE EMPLOYEE
ALTER COLUMN EmpName VARCHAR(150);

ALTER TABLE EMPLOYEE
ADD CONSTRAINT CK_Salary_Min CHECK (Salary >= 3000);

ALTER TABLE EMPLOYEE
ADD CONSTRAINT DF_HireDate DEFAULT GETDATE() FOR HireDate;

SELECT * FROM DEPARTMENT;
SELECT * FROM EMPLOYEE;
SELECT * FROM PROJECT;
SELECT * FROM EMPLOYEE_PROJECT;

